// Code.gs  (Apps Script)
// Pegar en tu proyecto Apps Script y desplegar como Web App (/exec)

const SHEET_NAME = "Registros";

const HEADERS = [
  "FechaHora",
  "Legajo",
  "N° Orden",
  "Sector",
  "Cod Art",
  "Pilas",
  "Cjas x Pila",
  "Cjas Sueltas",
  "Codigos Cargados (Pestaña 1)"
];

function doGet() {
  return ContentService.createTextOutput(JSON.stringify({ ok: true, msg: "WebApp activa" }))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  try {
    const sh = getSheet_();

    const raw = (e && e.postData && e.postData.contents) ? e.postData.contents : "{}";
    const data = JSON.parse(raw);

    const ts = data.ts ? new Date(data.ts) : new Date();
    const legajo = String(data.legajo || "").trim();
    const codesJoined = Array.isArray(data.codes) ? data.codes.join(",") : "";

    if (!legajo) {
      return jsonOut_({ ok: false, error: "Falta legajo" });
    }

    const rows = Array.isArray(data.rows) ? data.rows : [];

    if (rows.length === 0) {
      sh.appendRow([ts, legajo, "", "", "", "", "", "", codesJoined]);
      return jsonOut_({ ok: true, appended: 1, note: "Sin filas - solo legajo/codes" });
    }

    const values = rows.map(r => ([
      ts,
      legajo,
      (r.orden === null || r.orden === undefined) ? "" : r.orden,
      String(r.sector || ""),
      String(r.codArt || ""),
      String(r.pilas || ""),
      String(r.cjasXPila || ""),
      String(r.cjasSueltas || ""),
      codesJoined
    ]));

    sh.getRange(sh.getLastRow() + 1, 1, values.length, HEADERS.length).setValues(values);

    return jsonOut_({ ok: true, appended: values.length });

  } catch (err) {
    return jsonOut_({ ok: false, error: String(err && err.message ? err.message : err) });
  }
}

function getSheet_() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sh = ss.getSheetByName(SHEET_NAME);
  if (!sh) sh = ss.insertSheet(SHEET_NAME);

  if (sh.getLastRow() === 0) {
    sh.appendRow(HEADERS);
  } else {
    const a1 = sh.getRange(1, 1).getValue();
    if (!a1) sh.getRange(1, 1, 1, HEADERS.length).setValues([HEADERS]);
  }
  return sh;
}

function jsonOut_(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}
